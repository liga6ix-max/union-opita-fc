
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset is designed for a SINGLE-CLUB application.
     * The default posture is denial. Access is granted based on simple role checks (manager, coach, athlete).
     * Since there's only one club, complex checks for 'clubId' equality between documents are unnecessary and have been removed.
     * A manager ('admin' or 'manager') has broad permissions.
     */

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAnyManager() {
        // A user is a manager if they are signed in and their role is 'admin' or 'manager'.
        return isSignedIn() && getUserData().role in ['admin', 'manager'];
    }

    function isClubStaff(clubId) {
      return getUserData().role in ['admin', 'manager', 'coach'];
    }

    function isAnyCoach() {
        return isSignedIn() && getUserData().role in ['admin', 'manager', 'coach'];
    }
    
    function isClubAthlete(clubId) {
        return isSignedIn() && getUserData().role == 'athlete';
    }

    function isTheirCoach(athleteId) {
      let athleteDoc = get(/databases/$(database)/documents/clubs/OpitaClub/athletes/$(athleteId)).data;
      return isSignedIn() && isAnyCoach() && athleteDoc.coachId == request.auth.uid;
    }


    // --------------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------------

    match /clubs/{clubId} {
      allow get: if isSignedIn();
      allow list: if false; 
      allow create: if isSignedIn();
      allow update: if isAnyManager();
      allow delete: if false;
    }

    /**
     * @description Manages user profiles.
     *              - Managers can list and read any user.
     *              - Users can read/update their own profile.
     *              - Coaches can read the profiles of athletes assigned to them.
     */
    match /users/{userId} {
      allow get: if isAnyManager() || isOwner(userId) || isTheirCoach(userId);
      allow list: if isAnyManager();
      allow create: if true;
      allow update: if isOwner(userId) || isAnyManager() || isTheirCoach(userId);
      allow delete: if isAnyManager();
    }
    
    /**
     * @description Generic rule for all subcollections under a club.
     */
    match /clubs/{clubId}/{collection}/{docId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAnyManager();
    }

    /**
     * @description Athlete-specific overrides.
     */
    match /clubs/{clubId}/athletes/{athleteId} {
      allow get: if isAnyManager() || isOwner(athleteId) || isTheirCoach(athleteId);
      allow list: if isAnyManager();
      allow update: if isOwner(athleteId) || isAnyManager() || isTheirCoach(athleteId);
    }

    /**
     * @description Secures payment records.
     */
    match /clubs/{clubId}/payments/{paymentId} {
      allow get: if isClubStaff(clubId) || (isClubAthlete(clubId) && resource.data.athleteId == request.auth.uid);
      allow list: if isClubStaff(clubId) || (isClubAthlete(clubId) && request.query.filters.size() == 1 && request.query.filters[0].field == "athleteId" && request.query.filters[0].value == request.auth.uid);
      allow create: if isAnyManager();
      allow update: if isAnyManager() || (isClubAthlete(clubId) && resource.data.athleteId == request.auth.uid);
      allow delete: if isAnyManager();
    }

    /**
     * @description Manages tasks.
     */
    match /clubs/{clubId}/tasks/{taskId} {
      allow create: if isAnyCoach();
      allow update: if isOwner(resource.data.assigneeId) || isOwner(resource.data.assignerId) || isAnyManager();
    }

    /**
     * @description Manages public landing page content. Readable by anyone.
     */
    match /clubs/{clubId}/landingPageContent/{contentId} {
      allow get, list: if true;
      allow create, update, delete: if isAnyManager();
    }

     match /clubs/{clubId}/trainingEvents/{eventId} {
        allow get, list: if isSignedIn();
        allow create, update, delete: if isAnyManager();
     }

     match /clubs/{clubId}/attendance/{attendanceId} {
        allow create: if isAnyCoach();
     }
  }
}
