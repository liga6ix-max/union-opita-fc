
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset is designed for a SINGLE-CLUB application.
     * The default posture is denial. Access is granted based on simple role checks (manager, coach, athlete).
     * Since there's only one club, complex checks for 'clubId' equality between documents are unnecessary and have been removed.
     * A manager ('admin' or 'manager') has broad permissions.
     */

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAnyManager() {
        // A user is a manager if they are signed in and their role is 'admin' or 'manager'.
        return isSignedIn() && getUserData().role in ['admin', 'manager'];
    }

    function isAnyCoach() {
        return isSignedIn() && getUserData().role in ['admin', 'manager', 'coach'];
    }
    
    function isAnyAthlete() {
        return isSignedIn() && getUserData().role == 'athlete';
    }

    // New helper function to check if the requester is the coach of the target user
    function isTheirCoach(athleteId) {
      let athleteDoc = get(/databases/$(database)/documents/clubs/OpitaClub/athletes/$(athleteId)).data;
      return isSignedIn() && isAnyCoach() && athleteDoc.coachId == request.auth.uid;
    }


    // --------------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------------

    match /clubs/{clubId} {
      // Any signed-in user can read the single club document.
      allow get: if isSignedIn();
      allow list: if false; // Only one club doc, no need to list.
      allow create: if isSignedIn(); // Allow initial club creation
      allow update: if isAnyManager();
      allow delete: if false; // Prevent accidental deletion of the main club doc.
    }

    /**
     * @description Manages user profiles. This is the most critical collection for management.
     *              - ANY manager can list, read, update, and delete ANY user. This is required for the user management page.
     *              - Users can read/update their own profile.
     *              - Coaches can read the profiles of athletes assigned to them.
     *              - Anyone can create a user during sign-up.
     */
    match /users/{userId} {
      allow get: if isAnyManager() || isOwner(userId) || isTheirCoach(userId);
      allow list: if isAnyManager();
      allow create: if true; // Anyone can create a user document during sign-up.
      allow update: if isOwner(userId) || isAnyManager() || isTheirCoach(userId); // A user can update their own doc, a manager can update any, a coach can update their athlete's
      allow delete: if isAnyManager();
    }

    /**
     * @description Generic rule for all subcollections under a club.
     *              This simplifies management significantly for a single-club app.
     */
    match /clubs/{clubId}/{collection}/{docId} {
        // Default Read Access: Any signed-in user can read/list documents.
        // The app's queries are responsible for filtering data for the correct user.
        // This rule is broad for reads but simplifies development immensely for a single-club app.
        allow get, list: if isSignedIn();

        // Default Write Access: Only managers can create, update, or delete.
        // Specific collections below can provide more granular write access.
        allow create, delete: if isAnyManager();
        allow update: if isAnyManager();
    }

    /**
     * @description Athlete-specific overrides.
     *              An athlete can update their own profile, a manager can, or their coach can.
     */
    match /clubs/{clubId}/athletes/{athleteId} {
      allow get: if isAnyManager() || isOwner(athleteId) || isTheirCoach(athleteId);
      allow update: if isOwner(athleteId) || isAnyManager() || isTheirCoach(athleteId);
    }

    /**
     * @description Payment-specific overrides.
     *              An athlete can update their own payment record (e.g., add reference), or a manager can.
     */
    match /clubs/{clubId}/payments/{paymentId} {
        allow update: if (isAnyAthlete() && resource.data.athleteId == request.auth.uid) || isAnyManager();
    }

    /**
     * @description Task-specific overrides.
     *              - Coaches can create tasks.
     *              - The assignee, assigner, or a manager can update a task's status.
     */
    match /clubs/{clubId}/tasks/{taskId} {
        allow create: if isAnyCoach(); 
        allow update: if isOwner(resource.data.assigneeId) || isOwner(resource.data.assignerId) || isAnyManager();
    }

    /**
     * @description Attendance-specific overrides.
     */
    match /clubs/{clubId}/attendance/{attendanceId} {
        allow create: if isAnyCoach();
    }
  }
}
