
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset is designed for a SINGLE-CLUB application.
     * The default posture is denial. Access is granted based on simple role checks (manager, coach, athlete).
     * Since there's only one club, complex checks for 'clubId' equality between documents are unnecessary and have been removed.
     * A manager ('admin' or 'manager') has broad permissions.
     */

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAnyManager() {
        // A user is a manager if they are signed in and their role is 'admin' or 'manager'.
        return isSignedIn() && getUserData().role in ['admin', 'manager'];
    }

    function isAnyCoach() {
        return isSignedIn() && getUserData().role in ['admin', 'manager', 'coach'];
    }
    
    function isAnyAthlete() {
        return isSignedIn() && getUserData().role == 'athlete';
    }


    // --------------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------------

    match /clubs/{clubId} {
      // Any signed-in user can read the single club document.
      allow get: if isSignedIn();
      allow list: if false; // Only one club doc, no need to list.
      allow create: if isSignedIn(); // Allow initial club creation
      allow update: if isAnyManager();
      allow delete: if false; // Prevent accidental deletion of the main club doc.
    }

    /**
     * @description Manages user profiles. This is the most critical collection for management.
     *              - ANY manager can list, read, update, and delete ANY user. This is required for the user management page.
     *              - Users can read/update their own profile.
     *              - Anyone can create a user during sign-up.
     */
    match /users/{userId} {
      allow get: if isSignedIn(); // Allow any signed-in user to read any other user's profile.
      allow list: if isAnyManager(); // Managers can list all users for the management panel.
      allow create: if true; // Anyone can create a user document during sign-up.
      allow update: if isOwner(userId) || isAnyManager(); // A user can update their own doc, or a manager can update any doc.
      allow delete: if isAnyManager();
    }

    /**
     * @description Generic rule for all subcollections under a club.
     *              This simplifies management significantly for a single-club app.
     */
    match /clubs/{clubId}/{collection}/{docId} {
        // Default Read Access: Any signed-in user can read/list documents.
        // Specific collections can override this if needed.
        allow get, list: if isSignedIn();

        // Default Write Access: Only managers can create, update, or delete.
        allow create, update, delete: if isAnyManager();
    }

    /**
     * @description Athlete-specific overrides.
     */
    match /clubs/{clubId}/athletes/{athleteId} {
      allow get, list: if isSignedIn();
      allow create: if isAnyManager();
      // An athlete can update their own profile, or a manager can.
      allow update: if isOwner(athleteId) || isAnyManager();
      allow delete: if isAnyManager();
    }

    /**
     * @description Payment-specific overrides.
     */
    match /clubs/{clubId}/payments/{paymentId} {
        allow get, list: if isSignedIn();
        allow create: if isAnyManager();
        // An athlete can update their own payment record (e.g., add reference), or a manager can.
        allow update: if (isAnyAthlete() && resource.data.athleteId == request.auth.uid) || isAnyManager();
        allow delete: if isAnyManager();
    }

    /**
     * @description Task-specific overrides.
     */
    match /clubs/{clubId}/tasks/{taskId} {
        allow get, list: if isSignedIn();
        allow create: if isAnyCoach(); // Any coach or manager can create a task.
        // The assignee, assigner, or a manager can update a task's status.
        allow update: if isOwner(resource.data.assigneeId) || isOwner(resource.data.assignerId) || isAnyManager();
        allow delete: if isAnyManager();
    }

    /**
     * @description Attendance-specific overrides.
     */
    match /clubs/{clubId}/attendance/{attendanceId} {
        allow get, list: if isAnyCoach();
        allow create: if isAnyCoach();
        allow update, delete: if isAnyManager();
    }
  }
}
