
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isManager() {
      return isSignedIn() && getUserData(request.auth.uid).role == 'manager';
    }

    function isCoach() {
      return isSignedIn() && getUserData(request.auth.uid).role in ['manager', 'coach'];
    }

    function isAthlete() {
      return isSignedIn() && getUserData(request.auth.uid).role == 'athlete';
    }

    function isMemberOfTheClub(clubId) {
      // Check if the user document exists and has the corresponding clubId.
      let userData = getUserData(request.auth.uid);
      return isSignedIn() && ('clubId' in userData) && userData.clubId == clubId;
    }

    // --------------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------------

    // CLUBS
    match /clubs/{clubId} {
      // Any authenticated member of the club can read club details.
      // Managers can read any club document, essential for settings.
      allow read: if isManager() || (isSignedIn() && isMemberOfTheClub(clubId));
      // Only managers can create, update, or delete club documents.
      allow write: if isManager();
    }

    // USERS
    match /users/{userId} {
      // Any signed-in user can read any other user's profile.
      // This is required for security rules to be able to check roles.
      // Client-side queries will restrict what data is actually shown to users.
      allow read: if isSignedIn();
      
      // Anyone can create a user account (e.g., during sign-up).
      allow create: if true;
      
      // Managers can update any user. Users can update their own profile.
      allow update: if isManager() || isOwner(userId);
      
      // Only managers can delete users.
      allow delete: if isManager();
    }
    
    // Subcollections need to verify the user is part of the parent club OR is a manager.
    match /clubs/{clubId}/{document=**} {
        allow read, write: if isManager() || (isSignedIn() && isMemberOfTheClub(clubId));
    }
  }
}
