
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset enforces a role-based security model for a single-club
     * management application. A user's access to any data is primarily determined by their role
     * (admin, manager, coach, athlete). The default posture is denial; access is only granted explicitly.
     *
     * Key Security Decisions:
     * - Managers have broad permissions to manage club data and users.
     * - Users can generally read/write their own data.
     * - Public landing page content is readable by anyone.
     * - New users are disabled by default and must be enabled by a manager.
     */

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isClubMember(clubId) {
      return isSignedIn() && getUserData().clubId == clubId;
    }

    function isClubManager(clubId) {
      let userData = getUserData();
      return isClubMember(clubId) && userData.role in ['admin', 'manager'];
    }

    function isClubAdmin(clubId) {
      return isClubMember(clubId) && getUserData().role == 'admin';
    }

    function isClubStaff(clubId) {
      return isClubMember(clubId) && getUserData().role in ['admin', 'manager', 'coach'];
    }

    function isClubAthlete(clubId) {
      let userData = getUserData();
      return isClubMember(clubId) && userData.role == 'athlete';
    }

    // For a single-club app, any manager/admin has top-level permissions.
    function isAnyManager() {
        let userData = getUserData();
        return isSignedIn() && userData.role in ['admin', 'manager'];
    }
    
    function isMemberOfSameClubAsTarget(targetUserId) {
      let targetUserDoc = get(/databases/$(database)/documents/users/$(targetUserId));
      // Allow if target doesn't exist or has no clubId yet (pending user)
      if (!targetUserDoc.exists() || !('clubId' in targetUserDoc.data) || targetUserDoc.data.clubId == '') {
        return true;
      }
      return isSignedIn() && getUserData().clubId == targetUserDoc.data.clubId;
    }


    // --------------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------------

    match /clubs/{clubId} {
      allow get: if isClubMember(clubId);
      allow list: if false; 
      allow create: if isSignedIn();
      allow update: if isClubManager(clubId);
      allow delete: if isClubAdmin(clubId);
    }

    /**
     * @description Manages user profiles.
     *              - Managers can list and read any user.
     *              - Users can read/update their own profile.
     *              - Anyone can create a user document during sign-up.
     */
    match /users/{userId} {
      allow get: if isAnyManager() || isOwner(userId);
      allow list: if isAnyManager();
      allow create: if true;
      allow update: if isOwner(userId) || isAnyManager();
      allow delete: if isAnyManager();
    }

    /**
     * @description Stores athlete profiles. Club staff can list/read all. An athlete
     *              can read and update their own profile. Managers can create/delete.
     */
    match /clubs/{clubId}/athletes/{athleteId} {
      allow get: if isClubStaff(clubId) || isOwner(athleteId);
      // A manager can list all athletes if the query is scoped to their club.
      allow list: if isClubManager(clubId) && request.query.where[0][2] == clubId;
      allow create: if isClubManager(clubId);
      allow update: if isOwner(athleteId) || isClubManager(clubId);
      allow delete: if isClubManager(clubId);
    }

    /**
     * @description Secures payment records. Staff can read all payments. Athletes
     *              can only read their own payments. Managers manage payments.
     */
    match /clubs/{clubId}/payments/{paymentId} {
      allow get: if isClubStaff(clubId) || (isClubAthlete(clubId) && resource.data.athleteId == request.auth.uid);
      allow list: if isClubStaff(clubId) || (isClubAthlete(clubId) && request.query.where[0][2] == request.auth.uid);
      allow create: if isClubManager(clubId);
      allow update: if isClubManager(clubId) || (isOwner(resource.data.athleteId));
      allow delete: if isClubAdmin(clubId);
    }

    /**
     * @description Manages tasks. Club members can view tasks. Staff can create.
     *              Assigner, assignee, or manager can update.
     */
    match /clubs/{clubId}/tasks/{taskId} {
      allow get, list: if isClubMember(clubId);
      allow create: if isClubStaff(clubId) && request.resource.data.assignerId == request.auth.uid;
      allow update: if isClubMember(clubId) && (isClubManager(clubId) || request.auth.uid == resource.data.assignerId || request.auth.uid == resource.data.assigneeId);
      allow delete: if isClubManager(clubId);
    }

    /**
     * @description Manages public landing page content. Readable by anyone.
     *              Writable only by managers.
     */
    match /clubs/{clubId}/landingPageContent/{contentId} {
      allow get, list: if true;
      allow create, update, delete: if isClubManager(clubId);
    }

     match /clubs/{clubId}/trainingEvents/{eventId} {
        allow get, list: if isClubMember(clubId);
        allow create, update, delete: if isClubManager(clubId);
     }

     match /clubs/{clubId}/attendance/{attendanceId} {
        allow get, list: if isClubStaff(clubId);
        allow create: if isClubStaff(clubId);
        allow update, delete: if isClubManager(clubId);
     }
  }
}
