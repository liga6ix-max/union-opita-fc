
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserDoc(userId) {
      return get(/databases/$(database)/documents/users/$(userId));
    }

    function isManager() {
      let userDoc = getUserDoc(request.auth.uid);
      return isSignedIn() && userDoc != null && userDoc.data.role == 'manager';
    }

    function isCoach() {
      let userDoc = getUserDoc(request.auth.uid);
      return isSignedIn() && userDoc != null && userDoc.data.role in ['manager', 'coach'];
    }

    function isAssignedCoach(athleteId) {
      // First, check if the current user is a coach or manager
      if (!isCoach()) {
        return false;
      }
      // Get the user document of the athlete being modified to find their clubId
      let athleteUserDoc = getUserDoc(athleteId);
      if (athleteUserDoc == null || !('clubId' in athleteUserDoc.data)) {
        return false;
      }
      // Get the athlete-specific document from the subcollection
      let athleteDoc = get(/databases/$(database)/documents/clubs/$(athleteUserDoc.data.clubId)/athletes/$(athleteId));
      // Check if the athlete document exists and if the current user is the assigned coach
      return athleteDoc != null && ('coachId' in athleteDoc.data) && athleteDoc.data.coachId == request.auth.uid;
    }

    function isAthlete() {
      let userDoc = getUserDoc(request.auth.uid);
      return isSignedIn() && userDoc != null && userDoc.data.role == 'athlete';
    }

    function isMemberOfTheClub(clubId) {
      let userDoc = getUserDoc(request.auth.uid);
      // Check if the user document exists and has the corresponding clubId.
      return isSignedIn() && userDoc != null && ('clubId' in userDoc.data) && userDoc.data.clubId == clubId;
    }

    // --------------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------------

    // CLUBS
    match /clubs/{clubId} {
      // Any authenticated member of the club can read club details.
      // Managers can read any club document, essential for settings.
      allow read: if isManager() || (isSignedIn() && isMemberOfTheClub(clubId));
      // Only managers can create, update, or delete club documents.
      allow write: if isManager();
    }

    // USERS
    match /users/{userId} {
      // Any signed-in user can read any other user's profile.
      // This is required for security rules to be able to check roles.
      // Client-side queries will restrict what data is actually shown to users.
      allow read: if isSignedIn();
      
      // Anyone can create a user account (e.g., during sign-up).
      allow create: if true;
      
      // Managers can update any user. Users can update their own profile. Coaches can update their assigned athletes.
      allow update: if isManager() || isOwner(userId) || isAssignedCoach(userId);
      
      // Only managers can delete users.
      allow delete: if isManager();
    }
    
    // Subcollections need to verify the user is part of the parent club OR is a manager.
    match /clubs/{clubId}/{document=**} {
        allow read, write: if isManager() || (isSignedIn() && isMemberOfTheClub(clubId));
    }
  }
}
